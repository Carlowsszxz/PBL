<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/UMak_Logo_Registered.png">
    <title>LCD Messages - Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles/login.css">
    <link rel="stylesheet" href="styles/setup.css">
    <link rel="stylesheet" href="styles/lcd-messages.css">
    <style>
        /* Layout tweaks for lcd-messages page */
        .lcd-messages-full-width {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Card adjustments: a little more breathing room */
        .admin-card {
            padding: 1.25rem; /* 20px */
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border: 1px solid rgba(100,100,120,0.06);
        }

        .admin-card-header {
            margin-bottom: 0.75rem;
        }

        /* Form styles */
        .message-form .form-group {
            margin-bottom: 1rem;
        }

        #messageInput {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem 0.9rem;
            border-radius: 10px;
            border: 1px solid rgba(100,100,120,0.12);
            resize: vertical;
            font-size: 0.95rem;
            line-height: 1.25;
            background-color: rgba(255,255,255,0.02);
            color: inherit;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        .table-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(100,100,120,0.12);
            background-color: rgba(255,255,255,0.02);
            font-size: 0.95rem;
        }

        .character-count {
            margin-top: 0.35rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        /* LCD preview styling to emulate a 20x4 screen */
        .message-preview {
            margin-top: 1rem;
        }

        #previewContent {
            width: 100%;
            max-width: 420px;
            height: auto;
            min-height: 88px;
            padding: 12px 14px;
            border-radius: 10px;
            background: linear-gradient(180deg, #02180b 0%, #052215 100%);
            color: #b9f6b9;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.6), 0 8px 24px rgba(2,18,11,0.45);
            border: 1px solid rgba(0,0,0,0.45);
            white-space: pre-wrap;
        }

        .preview-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        /* Recent messages list items */
        .message-item {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(100,100,120,0.06);
            background-color: rgba(255,255,255,0.01);
            margin-bottom: 0.6rem;
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
            align-items: center;
        }

        .message-item .meta {
            font-size: 0.82rem;
            color: #9aa4b2;
        }

        /* Refresh button icon + text alignment */
        .btn-refresh {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media (max-width: 640px) {
            .lcd-messages-full-width { padding: 0 1rem; }
            #previewContent { max-width: 100%; }
        }
        /* One-time popup (appears once after delay) */
        .one-time-popup{
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 9999;
            display: none;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity .28s ease, transform .28s ease;
            background: linear-gradient(180deg, #ffffff, #fbfbfb);
            border: 1px solid rgba(15, 23, 42, 0.06);
            padding: 0.6rem 0.9rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
            min-width: 260px;
        }
        .one-time-popup.show{ display: block; opacity: 1; transform: none; }
        .one-time-popup .popup-inner{ display:flex; align-items:center; gap:0.5rem; }
        .one-time-popup .popup-message{ font-size:0.95rem; color:#0f172a; }
        .one-time-popup .popup-close{ margin-left:auto; background:transparent; border:none; font-size:1.1rem; line-height:1; cursor:pointer; color:#64748b; }
    </style>
</head>

<body class="text-slate-900 min-h-screen flex flex-col relative setup-body-bg" data-page="lcd-messages">
    <!-- Visual Effects -->
    <div id="cursor-follower" class="cursor-follower" aria-hidden="true"></div>
    <div id="library-background" class="library-background" aria-hidden="true"></div>
    <div id="paper-background" class="paper-background" aria-hidden="true"></div>


    <div class="admin-layout-container">
        <aside id="adminSidebar" class="admin-sidebar">
            <div class="sidebar-header">
                <img src="images/UMak_Logo_Registered.png" alt="University of Makati Logo" class="sidebar-logo" />
                <h1 class="sidebar-title">Admin Dashboard</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="setup.html" class="admin-nav-link" aria-label="Admin Dashboard"><i data-lucide="settings"
                        class="admin-nav-icon"></i><span class="admin-nav-text">Dashboard</span></a>
                <a href="user-management.html" class="admin-nav-link" aria-label="User Management"><i
                        data-lucide="users" class="admin-nav-icon"></i><span class="admin-nav-text">Users</span></a>
                <a href="rfid-management.html" class="admin-nav-link" aria-label="RFID Management"><i
                        data-lucide="contact" class="admin-nav-icon"></i><span class="admin-nav-text">Devices</span></a>
                <a href="student-reports.html" class="admin-nav-link" aria-label="Student Reports"><i
                        data-lucide="book-open-check" class="admin-nav-icon"></i><span
                        class="admin-nav-text">Reports</span></a>
                <a href="activity-logs.html" class="admin-nav-link" aria-label="Activity Logs"><i data-lucide="list"
                        class="admin-nav-icon"></i><span class="admin-nav-text">Activity</span></a>
                <a href="lcd-messages.html" class="admin-nav-link active" aria-label="LCD Messages"><i data-lucide="tv"
                        class="admin-nav-icon"></i><span class="admin-nav-text">LCD Messages</span></a>
            </nav>
            <div class="sidebar-footer">
                <a href="#" onclick="logout(); return false;" class="admin-nav-link logout-item" aria-label="Logout"><i
                        data-lucide="log-out" class="admin-nav-icon"></i><span class="admin-nav-text">Logout</span></a>
            </div>
        </aside>
        <main class="admin-main-content">
            <header class="admin-top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar"
                        aria-expanded="false" aria-controls="adminSidebar"><i data-lucide="menu"
                            class="w-5 h-5"></i></button>
                    <h1 class="page-title">LCD Messages</h1>
                </div>
                <div class="top-nav-right">
                    <div class="top-nav-profile">
                        <div class="profile-avatar">A</div>
                    </div>
                </div>
            </header>
            <div class="admin-content-grid">

                <!-- Send Message Card -->
                <section class="admin-card card-fadein lcd-messages-full-width">
                    <div class="admin-card-header">
                        <h2 class="text-lg font-semibold setup-title-color">Send Message to LCD Screen</h2>
                    </div>
                    <p class="text-slate-600 mb-6">Type a message below to display on the ESP32 LCD screen (20
                        characters per line, 4 lines).</p>
                    <form id="messageForm" class="message-form">
                        <div class="form-group">
                            <label for="tableSelect" class="form-label">Select Table:</label>
                            <select id="tableSelect" class="table-select px-3 py-2 text-sm">
                                <option value="table-1">Table 1</option>
                                <option value="table-2" disabled>Table 2 (Future Expansion)</option>
                                <option value="table-3" disabled>Table 3 (Future Expansion)</option>
                                <option value="table-4" disabled>Table 4 (Future Expansion)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="messageInput" class="form-label">Message (max 80 characters, 4 lines):</label>
                            <textarea id="messageInput" class="message-textarea mt-2"
                                placeholder="Enter your message here...&#10;Example:&#10;Welcome to Lab!&#10;Please maintain&#10;quiet environment"
                                maxlength="80"></textarea>
                            <div class="character-count"><span id="charCount">0</span> / 80 characters</div>
                        </div>

                        <div class="checkbox-group flex items-center gap-2 mb-3"><label><input type="checkbox" id="priorityCheck"> <span class="ml-1">Priority (display immediately, override current screen)</span></label></div>

                        <div class="checkbox-group flex items-center gap-2 mb-3"><label><input type="number" id="displayDuration" value="10" min="1" max="300" class="duration-input ml-2" style="width:6rem;"> <span class="ml-2">Display Duration (seconds, 1-300)</span></label></div>

                        <div class="button-group flex gap-3 flex-wrap">
                            <button type="submit" class="setup-btn btn btn-primary px-5 py-3">Send to LCD</button>
                            <button type="button" id="oneTimeBtn" class="px-5 py-3 rounded-xl text-slate-800 font-semibold shadow hover:bg-slate-100">Send One-Time Message</button>
                            <button type="button" onclick="clearMessage()" class="px-5 py-3 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold shadow">Clear Message</button>
                        </div>
                    </form>

                    <div id="messagePreview" class="message-preview hidden">
                        <div class="preview-label">LCD Preview (20 chars × 4 lines):</div>
                        <div id="previewContent" aria-live="polite"></div>
                    </div>

                    <div id="messageStatus" class="message-status hidden"></div>
                </section>

                <!-- Recent Messages Card -->
                <section class="admin-card card-fadein lcd-messages-full-width">
                    <div class="admin-card-header flex items-center justify-between">
                        <h2 class="text-lg font-semibold setup-title-color">Recent Messages</h2>
                        <button onclick="loadMessages()" class="btn btn-sm setup-btn btn-refresh" aria-label="Refresh messages list">
                            <i data-lucide="refresh-cw"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                    <div id="messageList" class="message-list">
                        <div class="p-4 text-sm text-slate-400">Loading messages...</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- One-time popup markup and behavior: shows after 10s, hides after a few seconds, then never shows again -->
    <div id="oneTimePopup" class="one-time-popup" role="status" aria-live="polite" aria-hidden="true">
        <div class="popup-inner">
            <div class="popup-message">Welcome to LCD Messages — this popup shows just once.</div>
            <button id="oneTimePopupClose" class="popup-close" aria-label="Dismiss">×</button>
        </div>
    </div>

    <!-- One-time message div triggered by button -->
    <div id="oneTimeMessage" class="one-time-popup" role="status" aria-live="polite" aria-hidden="true" style="left: 24px; bottom: 24px;">
        <div class="popup-inner">
            <div class="popup-message">This is a one-time message displayed only once when the button is clicked.</div>
            <button id="oneTimeMessageClose" class="popup-close" aria-label="Dismiss">×</button>
        </div>
    </div>

    <script>
    (function(){
        const KEY = 'lcd_messages_popup_shown_v1';
        try {
            if (localStorage.getItem(KEY)) return;
        } catch (e) { /* ignore storage errors */ }

        function showPopup() {
            const popup = document.getElementById('oneTimePopup');
            if (!popup) return;
            popup.setAttribute('aria-hidden','false');
            // reveal with class for transition
            requestAnimationFrame(() => popup.classList.add('show'));

            // auto-hide after 5 seconds
            const hideTimer = setTimeout(hidePopup, 5000);

            // manual close
            const closeBtn = document.getElementById('oneTimePopupClose');
            if (closeBtn) closeBtn.addEventListener('click', () => { clearTimeout(hideTimer); hidePopup(); });

            // mark as shown so it won't appear again
            try { localStorage.setItem(KEY, '1'); } catch (e) {}
        }

        function hidePopup() {
            const popup = document.getElementById('oneTimePopup');
            if (!popup) return;
            popup.classList.remove('show');
            popup.setAttribute('aria-hidden','true');
            popup.addEventListener('transitionend', function cleanup() { try{ popup.style.display = 'none'; } catch(e){} popup.removeEventListener('transitionend', cleanup); }, { once: true });
        }

        // show after 10 seconds (page load)
        window.addEventListener('load', function(){
            const params = new URLSearchParams(window.location.search);
            const force = params.get('showPopup') === '1' || params.get('debug_popup') === '1';
            if (force) {
                // ignore stored flag and show immediately for debugging
                try { localStorage.removeItem(KEY); } catch(e){}
                showPopup();
                return;
            }
            setTimeout(showPopup, 10000);
        });
    })();

    // One-time message triggered by button
    (function(){
        const KEY = 'one_time_message_shown_v1';
        let hasShown = false;
        try {
            hasShown = !!localStorage.getItem(KEY);
        } catch (e) { /* ignore */ }

        function showOneTimeMessage() {
            if (hasShown) return; // already shown, do nothing

            const popup = document.getElementById('oneTimeMessage');
            if (!popup) return;
            popup.setAttribute('aria-hidden','false');
            requestAnimationFrame(() => popup.classList.add('show'));

            // auto-hide after 5 seconds
            const hideTimer = setTimeout(hideOneTimeMessage, 5000);

            // manual close
            const closeBtn = document.getElementById('oneTimeMessageClose');
            if (closeBtn) closeBtn.addEventListener('click', () => { clearTimeout(hideTimer); hideOneTimeMessage(); });

            // mark as shown
            hasShown = true;
            try { localStorage.setItem(KEY, '1'); } catch (e) {}
        }

        function hideOneTimeMessage() {
            const popup = document.getElementById('oneTimeMessage');
            if (!popup) return;
            popup.classList.remove('show');
            popup.setAttribute('aria-hidden','true');
            popup.addEventListener('transitionend', function cleanup() { try{ popup.style.display = 'none'; } catch(e){} popup.removeEventListener('transitionend', cleanup); }, { once: true });
        }

        // Attach to button
        document.addEventListener('DOMContentLoaded', function(){
            const btn = document.getElementById('oneTimeBtn');
            if (btn) btn.addEventListener('click', showOneTimeMessage);
        });
    })();
    </script>
    <script src="scripts/login-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="scripts/lcd-messages.js"></script>
        <script>
            let __lcd_messages_blocked = false;
            function blockIfMobileOrTablet() {
                if (__lcd_messages_blocked) return;
                function isMobileOrTablet() {
                    const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    const isSmallScreen = window.innerWidth <= 1024;
                    const ua = navigator.userAgent.toLowerCase();
                    const isMobileUA = /android|iphone|ipad|ipod|blackberry|windows phone|opera mini|mobile|tablet/.test(ua);
                    return (hasTouch && isSmallScreen) || isMobileUA || isSmallScreen;
                }
                if (isMobileOrTablet()) {
                    __lcd_messages_blocked = true;
                    document.body.innerHTML = `
                        <div style="
                            min-height:100vh;
                            display:flex;
                            flex-direction:column;
                            justify-content:center;
                            align-items:center;
                            background:linear-gradient(135deg,#f8fafc 0%,#e0e7ef 100%);
                            color:#222;
                            font-family:Inter,sans-serif;
                            text-align:center;
                            padding:2rem;
                        ">
                            <div style="
                                background:#fff;
                                border-radius:1.25rem;
                                box-shadow:0 4px 24px rgba(0,0,0,0.07);
                                padding:2.5rem 1.5rem;
                                max-width:400px;
                                width:100%;
                            ">
                                <svg width="48" height="48" fill="none" viewBox="0 0 24 24" style="margin-bottom:1.5rem;display:block;margin-left:auto;margin-right:auto;">
                                    <rect width="24" height="24" rx="12" fill="#f3f4f6"/>
                                    <path d="M8 17h8M9 7h6a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z" stroke="#64748b" stroke-width="1.5"/>
                                    <path d="M12 15v2" stroke="#64748b" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                <h1 style="font-size:1.25rem;font-weight:600;margin-bottom:0.75rem;">This page is only accessible on a PC.</h1>
                                <p style="font-size:1rem;color:#64748b;">Please open this on a computer.</p>
                            </div>
                        </div>
                    `;
                    document.body.style.overflow = 'hidden';
                    window.addEventListener('resize', function () {}, { once: true });
                    window.addEventListener('scroll', function (e) { window.scrollTo(0,0); }, { passive: false });
                    document.addEventListener('touchmove', function(e){ e.preventDefault(); }, { passive: false });
                    document.addEventListener('wheel', function(e){ e.preventDefault(); }, { passive: false });
                }
            }
            document.addEventListener('DOMContentLoaded', blockIfMobileOrTablet);
            window.addEventListener('resize', blockIfMobileOrTablet);
        </script>
</body>

</html>
